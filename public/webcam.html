<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Klipper Webcam</title>
  
  <!-- HTML Meta Tags -->
  <meta name="description" content="Vue en direct de l'imprimante 3D Klipper">

  <!-- Facebook Meta Tags -->
  <meta property="og:url" content="/webcam">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Klipper Webcam Live">
  <meta property="og:description" content="Vue en direct de l'imprimante 3D Klipper">
  <meta property="og:image" content="/webcam/snapshot">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:domain" content="printer.mathilde.online">
  <meta property="twitter:url" content="/webcam">
  <meta name="twitter:title" content="Klipper Webcam Live">
  <meta name="twitter:description" content="Vue en direct de l'imprimante 3D Klipper">
  <meta name="twitter:image" content="/webcam/snapshot">

  <!-- Meta Tags Generated via https://www.opengraph.xyz -->
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #webcam-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #111;
    }

    #webcam-stream {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform: rotate(180deg);
    }

    #overlay-frame {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 400px;
      height: 600px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      z-index: 1000;
      background: rgba(0, 0, 0, 0.9);
    }

    #overlay-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
    }

    /* Responsive */
    @media (max-width: 900px) {
      #overlay-frame {
        width: 45vw;
        height: 60vh;
        top: 12px;
        left: 12px;
      }
    }

    @media (max-width: 600px) {
      #overlay-frame {
        width: 100vw;
        height: 45vh;
        top: auto;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 12px 12px 0 0;
      }

      #webcam-container {
        height: 60vh;
      }

      #webcam-stream {
        object-fit: cover;
      }
    }

    /* Ajuste le contenu de l'iframe pour √©viter le crop sur petits √©crans */
    #overlay-frame iframe {
      transform-origin: top left;
    }

    /* Mode fullscreen overlay - comportement diff√©rent PC vs mobile */
    /* Sur mobile: fullscreen = overlay prend tout l'√©cran */
    @media (max-width: 768px) {
      body.fullscreen-overlay #overlay-frame {
        width: 100vw;
        height: 100vh;
        top: 0;
        left: 0;
        border-radius: 0;
      }

      body.fullscreen-overlay #webcam-container {
        display: none;
      }
    }

    /* Sur PC: fullscreen = overlay superpos√© (comme avant) */
    @media (min-width: 769px) {
      body.fullscreen-overlay #overlay-frame {
        width: 500px;
        height: 700px;
        top: 20px;
        left: 20px;
        border-radius: 12px;
      }
    }

    /* Overlay cach√© par d√©faut */
    body.overlay-hidden #overlay-frame {
      display: none;
    }

    /* Loading indicator */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 14px;
    }

    /* Offline banner */
    .offline-banner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #f87171;
      padding: 40px 60px;
      border-radius: 16px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      z-index: 100;
      backdrop-filter: blur(8px);
      border: 2px solid rgba(248, 113, 113, 0.3);
    }

    /* Floating action button */
    #overlay-toggle {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 2000;
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
      cursor: pointer;
    }

    #overlay-toggle.active {
      background: rgba(79, 70, 229, 0.9);
    }

    @media (max-width: 600px) {
      #overlay-toggle {
        right: 12px;
        bottom: 12px;
        font-size: 13px;
        padding: 10px 14px;
      }
    }

    /* FPS Counter */
    #fps-counter {
      position: fixed;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #4cc9f0;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
      font-weight: 600;
      z-index: 1500;
      border: 1px solid rgba(76, 201, 240, 0.3);
      display: none;
    }

    #fps-counter.show {
      display: block;
    }

    @media (max-width: 600px) {
      #fps-counter {
        display: none !important;
      }
    }

    /* Notification Permission Banner */
    #notif-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(99, 102, 241, 0.95));
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      z-index: 3000;
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    #notif-banner.hidden {
      display: none;
    }

    #notif-banner .message {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
    }

    #notif-banner button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    #notif-banner .allow-btn {
      background: #fff;
      color: #3b82f6;
    }

    #notif-banner .allow-btn:hover {
      background: #f0f9ff;
    }

    #notif-banner .dismiss-btn {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    #notif-banner .dismiss-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <div id="notif-banner" class="hidden">
    <div class="message">üì¢ Activer les notifications pour recevoir les alertes d'imprimante</div>
    <button class="allow-btn" id="notif-allow">Activer</button>
    <button class="dismiss-btn" id="notif-dismiss">Fermer</button>
  </div>

  <div id="webcam-container">
    <img id="webcam-stream" src="" alt="Webcam stream">
    <div class="loading" id="loading-indicator">Chargement de la webcam...</div>
    <div class="offline-banner" id="offline-banner" style="display: none;">
      <div style="font-size: 24px; margin-bottom: 10px;">üî¥</div>
      <div>L'imprimante est hors-ligne...</div>
    </div>
  </div>

  <div id="overlay-frame">
    <iframe id="overlay-iframe" src="/overlay?pos=top-left" frameborder="0"></iframe>
  </div>

  <button id="overlay-toggle" type="button">Afficher overlay</button>

  <div id="fps-counter">FPS: 0</div>

  <script>
    // Configuration
    const urlParams = new URLSearchParams(window.location.search);
    const moonrakerUrl = urlParams.get('moonraker') || '/api/webcam'; // Peut √™tre customis√©
    const fullscreenOverlay = urlParams.get('fullscreen') === '1';
    const position = urlParams.get('pos') || 'top-left';

    // Appliquer le mode fullscreen si demand√©
    if (fullscreenOverlay) {
      document.body.classList.add('fullscreen-overlay');
    }

    // Overlay visible par d√©faut (masquable via bouton)
    // (pas d'ajout de overlay-hidden)

    // Positionner l'overlay
    const overlayFrame = document.getElementById('overlay-frame');
    const overlayIframe = document.getElementById('overlay-iframe');
    const overlayToggle = document.getElementById('overlay-toggle');
    if (position === 'top-right') {
      overlayFrame.style.left = 'auto';
      overlayFrame.style.right = '20px';
    } else if (position === 'bottom-left') {
      overlayFrame.style.top = 'auto';
      overlayFrame.style.bottom = '20px';
    } else if (position === 'bottom-right') {
      overlayFrame.style.left = 'auto';
      overlayFrame.style.right = '20px';
      overlayFrame.style.top = 'auto';
      overlayFrame.style.bottom = '20px';
    }

    // Ajuster l'√©chelle de l'overlay pour mobile (√©vite le crop)
    function getOverlayScale() {
      const w = window.innerWidth;
      if (w <= 420) return 0.68;
      if (w <= 600) return 0.75;
      if (w <= 900) return 0.85;
      return 1.0;
    }

    function applyOverlayScale() {
      const baseScale = getOverlayScale();
      const isFullscreen = document.body.classList.contains('fullscreen-overlay');
      const isMobile = window.innerWidth <= 768;
      // Sur mobile fullscreen: zoom x2, sur PC fullscreen: zoom normal
      const effectiveScale = (isFullscreen && isMobile) ? baseScale * 2 : baseScale;
      const overlayUrl = `/overlay?pos=top-left&scale=${effectiveScale}`;
      overlayIframe.src = overlayUrl;
      overlayIframe.style.transform = `scale(${effectiveScale})`;
    }

    applyOverlayScale();
    window.addEventListener('resize', applyOverlayScale);

    // Bouton flottant pour activer/d√©sactiver le fullscreen overlay
    function updateToggleLabel() {
      const isFullscreen = document.body.classList.contains('fullscreen-overlay');
      const isHidden = document.body.classList.contains('overlay-hidden');
      const isMobile = window.innerWidth <= 768;
      
      if (isHidden) {
        overlayToggle.textContent = 'Afficher overlay';
      } else if (isMobile && isFullscreen) {
        overlayToggle.textContent = 'Quitter plein √©cran';
      } else {
        overlayToggle.textContent = 'Masquer overlay';
      }
      overlayToggle.classList.toggle('active', !isHidden);
    }

    overlayToggle.addEventListener('click', () => {
      const isHidden = document.body.classList.contains('overlay-hidden');
      const isMobile = window.innerWidth <= 768;
      
      if (isHidden) {
        // Afficher l'overlay
        document.body.classList.remove('overlay-hidden');
        // Sur mobile seulement: activer le fullscreen
        if (isMobile) {
          document.body.classList.add('fullscreen-overlay');
        }
      } else {
        // Cacher l'overlay
        document.body.classList.remove('fullscreen-overlay');
        document.body.classList.add('overlay-hidden');
      }
      updateToggleLabel();
    });

    updateToggleLabel();

    // Charger la webcam
    const webcamStream = document.getElementById('webcam-stream');
    const webcamContainer = document.getElementById('webcam-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const offlineBanner = document.getElementById('offline-banner');

    // V√©rifier le status de l'imprimante
    async function checkPrinterStatus() {
      try {
        const response = await fetch('/api/status');
        if (!response.ok) {
          offlineBanner.style.display = 'flex';
          offlineBanner.style.alignItems = 'center';
          offlineBanner.style.justifyContent = 'center';
          offlineBanner.style.flexDirection = 'column';
          return false;
        }
        const data = await response.json();
        
        if (!data.success || data.data.state === 'disconnected') {
          offlineBanner.style.display = 'flex';
          offlineBanner.style.alignItems = 'center';
          offlineBanner.style.justifyContent = 'center';
          offlineBanner.style.flexDirection = 'column';
          
          // Si l'imprimante √©tait connect√©e, elle vient de se d√©connecter
          if (window.lastPrinterOnline) {
            console.log('‚ö†Ô∏è Imprimante d√©connect√©e');
            window.lastPrinterOnline = false;
          }
          return false;
        } else {
          offlineBanner.style.display = 'none';
          
          // Si l'imprimante √©tait d√©connect√©e, elle vient de se reconnecter
          if (!window.lastPrinterOnline && window.lastPrinterOnline !== undefined) {
            console.log('‚úÖ Imprimante reconnect√©e - envoi de notification');
            sendNotification('üñ®Ô∏è Imprimante en ligne!', {
              body: 'Klipper est de retour en ligne',
              icon: '/favicon.ico',
              tag: 'printer-online',
              requireInteraction: false
            });
          }

          // V√©rifier la fin d'impression
          const currentState = data.data.state;
          if (window.lastPrinterState === 'printing' && currentState === 'idle') {
            console.log('‚úÖ Impression termin√©e - envoi de notification');
            const filename = data.data.filename || 'Fichier inconnu';
            sendNotification('‚úÖ Impression termin√©e!', {
              body: `${filename}\nTermin√©e avec succ√®s`,
              icon: '/favicon.ico',
              tag: 'print-complete',
              requireInteraction: false
            });
          }

          window.lastPrinterState = currentState;
          window.lastPrinterOnline = true;
          return true;
        }
      } catch (error) {
        console.error('Erreur v√©rification printer status:', error);
        offlineBanner.style.display = 'flex';
        offlineBanner.style.alignItems = 'center';
        offlineBanner.style.justifyContent = 'center';
        offlineBanner.style.flexDirection = 'column';
        window.lastPrinterOnline = false;
        return false;
      }
    }

    // Fonction pour envoyer une notification
    function sendNotification(title, options = {}) {
      if (!('Notification' in window)) {
        console.log('Les notifications ne sont pas support√©es par ce navigateur');
        return;
      }

      if (Notification.permission === 'granted') {
        new Notification(title, options);
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            new Notification(title, options);
          }
        });
      }
    }

    // Bandeau de permission de notification
    const notifBanner = document.getElementById('notif-banner');
    const notifAllow = document.getElementById('notif-allow');
    const notifDismiss = document.getElementById('notif-dismiss');

    function updateNotificationBanner() {
      if ('Notification' in window) {
        const isHttps = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
        
        if (!isHttps) {
          // HTTP: notifications non disponibles
          notifBanner.innerHTML = '<div class="message">üîí Les notifications requirent HTTPS. Acc√®de via https://... pour les activer</div><button class="dismiss-btn" id="notif-dismiss-http">Fermer</button>';
          notifBanner.classList.remove('hidden');
          document.getElementById('notif-dismiss-http').addEventListener('click', () => {
            notifBanner.classList.add('hidden');
          });
        } else if (Notification.permission === 'default' || Notification.permission === 'denied') {
          // HTTPS: afficher bandeau de permission
          notifBanner.innerHTML = '<div class="message">üì¢ Activer les notifications pour recevoir les alertes d\'imprimante</div><button class="allow-btn" id="notif-allow">Activer</button><button class="dismiss-btn" id="notif-dismiss">Fermer</button>';
          notifBanner.classList.remove('hidden');
          
          document.getElementById('notif-allow').addEventListener('click', () => {
            console.log('Clic sur Activer, permission actuelle:', Notification.permission);
            Notification.requestPermission().then(permission => {
              console.log('Permission retourn√©e:', permission);
              if (permission === 'granted') {
                notifBanner.classList.add('hidden');
                sendNotification('‚úÖ Notifications activ√©es!', {
                  body: 'Tu recevras des alertes sur ta imprimante',
                  icon: '/favicon.ico'
                });
              }
              updateNotificationBanner();
            });
          });

          document.getElementById('notif-dismiss').addEventListener('click', () => {
            notifBanner.classList.add('hidden');
          });
        } else {
          notifBanner.classList.add('hidden');
        }
      } else {
        notifBanner.classList.add('hidden');
      }
    }

    // V√©rifier le status au d√©marrage et tous les 5 secondes
    checkPrinterStatus();
    setInterval(checkPrinterStatus, 5000);

    // Construire l'URL du flux webcam Moonraker
    function loadWebcam() {
      // Priorit√© 1: Stream MJPEG direct (meilleur pour fluidit√©)
      // Priorit√© 2: Snapshot fallback
      
      const streamUrls = [
        'http://192.168.1.155/webcam/stream',            // ‚úÖ Stream MJPEG direct
        'http://192.168.1.155:8080/webcam/stream',       // Proxy stream
        '/webcam/stream',                                 // Proxy local
      ];

      const snapshotUrls = [
        '/webcam/snapshot',                               // Proxy snapshot fallback
        'http://192.168.1.155:8080/webcam/snapshot',    // Snapshot fallback
      ];

      // Si customis√© via param√®tre
      const moonrakerUrl = urlParams.get('moonraker') || null;
      if (moonrakerUrl) {
        streamUrls.unshift(moonrakerUrl);
      }

      // Combiner: stream en priorit√©
      let allUrls = [...streamUrls, ...snapshotUrls];
      let currentIndex = 0;

      function tryNextUrl() {
        if (currentIndex >= allUrls.length) {
          console.error('‚ùå Impossible de charger la webcam');
          loadingIndicator.innerHTML = '<div style="color: #f44; text-align: center; padding: 20px;"><p>‚ùå Webcam non disponible</p><p style="font-size: 12px; color: #888; margin-top: 10px;">V√©rifiez que http://192.168.1.155/webcam/stream est accessible</p></div>';
          return;
        }

        const url = allUrls[currentIndex];
        const isStream = currentIndex < streamUrls.length;
        const urlType = isStream ? 'üé• Stream' : 'üì∏ Snapshot';
        
        console.log(`üîç Essai ${urlType} (${currentIndex + 1}/${allUrls.length}): ${url}`);
        
        let timeout = setTimeout(() => {
          console.log(`‚è±Ô∏è Timeout sur ${url}`);
          currentIndex++;
          tryNextUrl();
        }, 4000);

        const testImg = new Image();
        testImg.crossOrigin = 'anonymous';
        
        testImg.onload = () => {
          clearTimeout(timeout);
          console.log(`‚úÖ Webcam trouv√©e (${urlType}) √†: ${url}`);
          loadingIndicator.style.display = 'none';
          
          if (isStream) {
            // Mode stream MJPEG: charger directement, pas de refresh
            webcamStream.src = url;
            console.log('üé• Mode stream MJPEG activ√© (natif)');
          } else {
            // Mode snapshot: recharger l'image toutes les 300ms
            function updateSnapshot() {
              webcamStream.src = url + '?t=' + Date.now();
            }
            webcamStream.src = url;
            setInterval(updateSnapshot, 300);
            console.log('üì∏ Mode snapshot activ√© (300ms)');
          }
        };

        testImg.onerror = () => {
          clearTimeout(timeout);
          console.log(`‚ùå ${urlType} √©chou√©e: ${url}`);
          currentIndex++;
          tryNextUrl();
        };

        testImg.src = url;
      }

      tryNextUrl();
    }

    // Charger au d√©marrage
    loadWebcam();

    console.log('üé• Webcam Overlay charg√©');
    console.log('Position de l\'overlay:', position);
    console.log('Mode fullscreen:', fullscreenOverlay);

    // FPS Counter - Compte les vrais frames
    const fpsCounter = document.getElementById('fps-counter');
    let frameCount = 0;
    let lastFpsUpdate = Date.now();
    let streamMode = 'stream';
    let lastFrameTime = Date.now();
    let frameChangeCount = 0;

    // Observer pour d√©tecter les changements de src
    const originalDescriptor = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');
    let currentSrc = webcamStream.src;

    Object.defineProperty(webcamStream, 'src', {
      get() { 
        return currentSrc; 
      },
      set(value) {
        if (value !== currentSrc) {
          frameChangeCount++;
          streamMode = value.includes('snapshot') ? 'snapshot' : 'stream';
        }
        currentSrc = value;
        originalDescriptor.set.call(webcamStream, value);
      }
    });

    // Counter pour stream MJPEG - mesurer via requestAnimationFrame + d√©tection de changement
    let lastStreamCheckTime = Date.now();
    let estimatedStreamFps = 0;

    function measureStreamFps() {
      const now = Date.now();
      const delta = now - lastStreamCheckTime;
      
      // Tous les 500ms, estimer le FPS bas√© sur les requestAnimationFrames
      if (delta > 500) {
        // On compte combien de fois cette fonction a √©t√© appel√©e en 500ms
        // Si elle est appel√©e 30 fois en 500ms = 60 FPS (max browser refresh)
        estimatedStreamFps = Math.min(60, Math.round((frameChangeCount / delta) * 1000));
        lastStreamCheckTime = now;
        frameChangeCount = 0;
      }
      
      requestAnimationFrame(measureStreamFps);
    }

    measureStreamFps();

    // Mettre √† jour l'affichage FPS toutes les secondes
    setInterval(() => {
      const now = Date.now();
      const elapsed = (now - lastFpsUpdate) / 1000;
      const snapshotFps = Math.round(frameCount / elapsed);
      
      if (streamMode === 'snapshot') {
        fpsCounter.textContent = `üì∏ ${snapshotFps} FPS`;
      } else {
        // Pour le stream, utiliser l'estimation
        fpsCounter.textContent = `üé• ${estimatedStreamFps || '~30'} FPS`;
      }
      fpsCounter.classList.add('show');
      
      console.log(`üìä Mode: ${streamMode}, FPS: ${streamMode === 'snapshot' ? snapshotFps : estimatedStreamFps}`);
      frameCount = 0;
      lastFpsUpdate = now;
    }, 1000);
  </script>
</body>
</html>
